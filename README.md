# Terraform to deploy our cloud infrastructure

Terraform is used to specify our infrastructure as code (IaC). We will use Terraform to deploy the cloud infrastructure of the D3I pilot, all cloud configurations are in the config file. If changes need to be made to the cloud infrastructure, this has to be done using these config files.

Why are we doing it this way?

- We can apply version control to the IaC
- Our infrastructure will be replicable, by us and by others

# How to use Terraform

## Preparation

1. Install `terraform`. 
2. Install `azure cli` (az) (used by terraform to interact with Azure)
3. Run 'az login' to authenticate to the azure cli tool (az) and follow in structions

Look at the tutorials below to get the basics of terraform. 

The --use-device-code option below is only required if you don't have a browser on the system (bastion host)

    az login --use-device-code --tenant xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxx

## Terraform initialisation

1. cd setupTerraForm
```
terraform init
```

Although not required you may want to look at / change variables in backend.conf

The above command creates an exclusive storage environment for terraform state.
Destroying resources of the app will not affect the terraform state.

## Deploy the web app

1. Decide if you need to edit the terraform.tfvars file to change variable values.
2. Run the command below

```
cd ..
cd setupd3i
terraform init -backend-config=backend.conf
time terraform apply -auto-approve
```

## Tutorials

- [Video 1](https://www.youtube.com/watch?v=7xngnjfIlK4)
- [Video 2](https://www.youtube.com/watch?v=RTEgE2lcyk4)
- [Blog about managed identities](https://pontifex.dev/posts/terraform-azure-managed-identity/)
- [Link to the ARM templates](https://docs.microsoft.com/en-au/azure/templates/)
- [Link to tips managing secrets in Terraform](https://blog.gruntwork.io/a-comprehensive-guide-to-managing-secrets-in-your-terraform-code-1d586955ace1)

### The sequence of commands are:

```
terraform init          # Initialize
terraform fmt           # Formats your config files neatly
terraform validate      # Validates your configs
terraform plan          # Checks the tfstate file, what changes need to be apply
terraform apply         # Applies the changes
terraform destroy       # Destroys all resources
```

## Notes

On linux a working nameserver needs to be set in /etc/resolv.conf
Even if you do not use /etc/resolv.conf config yourself, terraform needs it


# Azure components of the D3I-Pilot

Below is a diagram of the components on Azure that the software of the D3I-pilot is running on.
The components will be described in more detail below.
For the exact configuration of the individual components see the terraform configuration files.

![Azure components](/resources/Azure_components.svg)

### Azure subscription

The Azure subscription the components will be created in.

### Storage account with the Terraform state files

This storage account will hold Terraform state files. These files will be used by Terraform to keep track of the difference components on Azure.

### Cost monitoring

Cost monitoring is configured for the resource groups that contain the components of the data donation app. If costs exceed a preset limit the administrator will be notified by email.

### Container registry

This container registry holds the images that contain the app. Azure app services is configured to pull images from this container registry.
Note that in the current setup the container images for the data donation app are pulled from an external registry, this container registry can be used in the future instead.

The pull credentials are configure with RBAC and managed identities; Azure app services is configured with a system managed identity, and a pull role for this container registry will be assigned to this identity.

### Azure app service with a web server

This Azure app service runs a minimalist web server that serves the following static content: contact page, support page and instructions in pdf format for the participant. The data donation app contains hard coded references to this web server.

### Azure app service with the data donation app

This Azure app service runs the data donation app. Diagnostics generated by the usage of this app is logged to storage account that the donated data resides in. 
The app service is granted access to the storage account through an Shared Access Signature (SAS) with write only access. Traffic to the storage account is routed internally on Azure.

Azure app services handles the: domain name, DNS, availability, certificates for TLS.

### PostgreSQL database

This database is used by the data donation app.

### Storage account with the donated data

This storage account contains the donated data, and contains diagnostics from the data donation app. This storage account is behind a firewall and only accessible for authorized users.

### Storage account with logging data

This storage account contains the logs of the activity on the storage account containing the donated data. 

